<script>
// è³å“ã¨ç¢ºç‡ï¼‹è‰²
const prizes = [
  { name: "ğŸ– æ¥µä¸Šå’Œç‰› 200g", chance: 3, color: "#FFD700" }, // é‡‘
  { name: "ğŸ¥ˆ åšåˆ‡ã‚Šä¸Šã‚¿ãƒ³ 150g", chance: 7, color: "#FF8C00" }, // æ©™
  { name: "ğŸº ãƒ‰ãƒªãƒ³ã‚¯1æ¯", chance: 20, color: "#00BFFF" }, // æ°´è‰²
  { name: "ğŸ’´ æ¬¡å›10%OFF", chance: 30, color: "#32CD32" }, // ç·‘
  { name: "ğŸ˜„ ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­", chance: 40, color: "#A9A9A9" } // ç°
];

// ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæç”»é–¢æ•°
function drawRoulette(colors = null) {
  const sliceAngle = 2 * Math.PI / prizes.length;
  for (let i = 0; i < prizes.length; i++) {
    ctx.beginPath();
    ctx.moveTo(center, center);
    ctx.arc(center, center, radius, i * sliceAngle, (i+1) * sliceAngle);
    ctx.fillStyle = colors ? colors[i] : prizes[i].color;
    ctx.fill();
    ctx.stroke();
  }
}

// æŠ½é¸é–¢æ•°ï¼ˆç¢ºç‡é€šã‚Šï¼‰
drawButton.onclick = () => {
  drawButton.disabled = true;
  gachaSound.currentTime = 0;
  gachaSound.play();

  const rand = Math.random() * 100;
  let sum = 0;
  let prizeIndex = 0;
  for (let i = 0; i < prizes.length; i++) {
    sum += prizes[i].chance;
    if (rand < sum) {
      prizeIndex = i;
      break;
    }
  }
  const prize = prizes[prizeIndex].name;

  const sliceAngleDeg = 360 / prizes.length;
  const targetRotation = 360*5 - prizeIndex*sliceAngleDeg + Math.random()*sliceAngleDeg;

  let startTime = null;
  function animate(time) {
    if(!startTime) startTime = time;
    const elapsed = time - startTime;
    const duration = 5000;
    const progress = Math.min(elapsed/duration, 1);
    const eased = easeOutCubic(progress);
    const currentRotation = eased * targetRotation;

    ctx.clearRect(0,0,size,size);
    drawRoulette(); // è‰²ä»˜ãã‚¹ãƒ©ã‚¤ã‚¹
    drawLightRing(currentRotation * Math.PI/180);

    if(progress < 1){
      requestAnimationFrame(animate);
    } else {
      resultElem.innerText = "ğŸ‰ " + prize + " ğŸ‰";
      const today = new Date();
      localStorage.setItem("gachaDate", today.toISOString());
      const nextDate = new Date(today);
      nextDate.setDate(today.getDate()+7);
      infoElem.innerText = `æœ€å¾Œã«æŒ‘æˆ¦ã—ãŸæ—¥: ${today.toLocaleDateString()} \næ¬¡å›æŒ‘æˆ¦å¯èƒ½æ—¥: ${nextDate.toLocaleDateString()}`;
    }
  }

  requestAnimationFrame(animate);
}
</script>
